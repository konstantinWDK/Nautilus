#!/bin/bash
# Script post-instalaciÃ³n para nautilus-vscode-widget

set -e

echo "Configurando Nautilus VSCode Widget..."

# Detener TODAS las instancias anteriores que estÃ©n ejecutÃ¡ndose
echo "Deteniendo versiones anteriores..."
pkill -f "nautilus-vscode-widget.py" 2>/dev/null || true
pkill -f "nautilus-vscode-widget" 2>/dev/null || true
sleep 1

# Si aÃºn hay procesos, forzar cierre
if pgrep -f "nautilus-vscode-widget" >/dev/null 2>&1; then
    echo "Forzando cierre de procesos..."
    pkill -9 -f "nautilus-vscode-widget.py" 2>/dev/null || true
    pkill -9 -f "nautilus-vscode-widget" 2>/dev/null || true
    sleep 1
fi

# Crear directorio de configuraciÃ³n para cada usuario
for user_home in /home/*; do
    if [ -d "$user_home" ]; then
        username=$(basename "$user_home")

        # Crear directorio autostart si no existe
        autostart_dir="$user_home/.config/autostart"
        mkdir -p "$autostart_dir"

        # Crear archivo .desktop para autostart
        cat > "$autostart_dir/nautilus-vscode-widget.desktop" << 'EOF'
[Desktop Entry]
Type=Application
Name=Nautilus VSCode Widget
Comment=Floating button to open folders in VSCode from Nautilus
Exec=/usr/bin/nautilus-vscode-widget
Icon=nautilus-vscode-widget
Terminal=false
Hidden=false
X-GNOME-Autostart-enabled=true
Categories=Utility;Development;
StartupNotify=false
EOF

        # Establecer permisos correctos
        chown "$username:$username" "$autostart_dir/nautilus-vscode-widget.desktop" 2>/dev/null || true
        chmod +x "$autostart_dir/nautilus-vscode-widget.desktop" 2>/dev/null || true
    fi
done

# Actualizar cachÃ© de iconos
echo "Actualizando cachÃ© de iconos..."
if command -v gtk-update-icon-cache >/dev/null 2>&1; then
    gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
fi

# Actualizar base de datos de aplicaciones
if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database /usr/share/applications 2>/dev/null || true
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Nautilus VSCode Widget instalado correctamente"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "VersiÃ³n: 3.2.2"
echo ""
echo "ğŸ“ UbicaciÃ³n del programa: /usr/share/nautilus-vscode-widget/"
echo "âš™ï¸  ConfiguraciÃ³n guardada en: ~/.config/nautilus-vscode-widget/"
echo ""
echo "ğŸ”„ Se iniciarÃ¡ automÃ¡ticamente en cada inicio de sesiÃ³n"
echo ""
echo "ğŸ’¡ Comandos Ãºtiles:"
echo "   â€¢ Iniciar:      nautilus-vscode-widget"
echo "   â€¢ Reiniciar:    pkill -f nautilus-vscode-widget && nautilus-vscode-widget"
echo "   â€¢ Ver procesos: ps aux | grep nautilus-vscode-widget"
echo ""
echo "âš ï¸  Para iniciar ahora, ejecuta: nautilus-vscode-widget"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

exit 0
