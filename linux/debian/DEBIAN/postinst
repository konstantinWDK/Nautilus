#!/bin/bash
# Script post-instalación para nautilus-vscode-widget

set -e

echo "Configurando Nautilus VSCode Widget..."

# Detener cualquier instancia anterior que esté ejecutándose (de forma más segura)
echo "Deteniendo versiones anteriores..."
if pgrep -f "nautilus-vscode-widget.py" >/dev/null; then
    pkill -f "nautilus-vscode-widget.py" 2>/dev/null || true
    sleep 1
fi

# Limpiar archivos de instalaciones anteriores inconsistentes
echo "Limpiando instalaciones anteriores inconsistentes..."
if dpkg -l | grep -q "nautilus-vscode-widget"; then
    # Si el paquete está en estado inconsistente, limpiarlo
    if dpkg --status nautilus-vscode-widget 2>/dev/null | grep -q "Status:.*unpacked"; then
        echo "Limpieza de estado inconsistente..."
        mv /var/lib/dpkg/info/nautilus-vscode-widget.* /tmp/ 2>/dev/null || true
        dpkg --remove --force-remove-reinstreq nautilus-vscode-widget 2>/dev/null || true
    fi
fi

# Crear directorio de configuración para cada usuario
for user_home in /home/*; do
    if [ -d "$user_home" ]; then
        username=$(basename "$user_home")

        # Crear directorio autostart si no existe
        autostart_dir="$user_home/.config/autostart"
        mkdir -p "$autostart_dir"

        # Crear archivo .desktop para autostart
        cat > "$autostart_dir/nautilus-vscode-widget.desktop" << 'EOF'
[Desktop Entry]
Type=Application
Name=Nautilus VSCode Widget
Comment=Floating button to open folders in VSCode from Nautilus
Exec=/usr/bin/nautilus-vscode-widget
Icon=nautilus-vscode-widget
Terminal=false
Hidden=false
X-GNOME-Autostart-enabled=true
Categories=Utility;Development;
StartupNotify=false
EOF

        # Establecer permisos correctos
        chown "$username:$username" "$autostart_dir/nautilus-vscode-widget.desktop" 2>/dev/null || true
        chmod +x "$autostart_dir/nautilus-vscode-widget.desktop" 2>/dev/null || true
    fi
done

# Actualizar caché de iconos
echo "Actualizando caché de iconos..."
if command -v gtk-update-icon-cache >/dev/null 2>&1; then
    gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
fi

# Actualizar base de datos de aplicaciones
if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database /usr/share/applications 2>/dev/null || true
fi

# Iniciar automáticamente la nueva versión
echo "Iniciando nueva versión..."
/usr/bin/nautilus-vscode-widget &

echo "Nautilus VSCode Widget instalado correctamente."
echo "Versión: $(dpkg -s nautilus-vscode-widget 2>/dev/null | grep Version | cut -d' ' -f2 || echo 'Nueva instalación')"
echo "El programa se iniciará automáticamente en el próximo inicio de sesión."
echo "O puedes iniciarlo manualmente con: nautilus-vscode-widget"

exit 0
