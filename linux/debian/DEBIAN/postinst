#!/bin/bash
# postinst script para nautilus-vscode-widget v3.3.6
# Instalador mejorado - versiÃ³n estable

set -e

# Colores
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

case "$1" in
    configure)
        echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${CYAN}â•‘    Nautilus VSCode Widget v3.3.6 - InstalaciÃ³n Exitosa      â•‘${NC}"
        echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

        echo -e "${CYAN}â„¹ï¸  ğŸ” Verificando archivos instalados...${NC}"
        
        # Verificar archivos instalados
        if [ -f "/usr/share/nautilus-vscode-widget/nautilus-vscode-widget.py" ]; then
            echo -e "${GREEN}âœ…   âœ“ /usr/share/nautilus-vscode-widget/nautilus-vscode-widget.py${NC}"
        else
            echo -e "${RED}âŒ   âœ— /usr/share/nautilus-vscode-widget/nautilus-vscode-widget.py${NC}"
        fi
        
        if [ -f "/usr/bin/nautilus-vscode-widget" ]; then
            echo -e "${GREEN}âœ…   âœ“ /usr/bin/nautilus-vscode-widget${NC}"
        else
            echo -e "${RED}âŒ   âœ— /usr/bin/nautilus-vscode-widget${NC}"
        fi
        
        if [ -f "/usr/share/applications/nautilus-vscode-widget.desktop" ]; then
            echo -e "${GREEN}âœ…   âœ“ /usr/share/applications/nautilus-vscode-widget.desktop${NC}"
        else
            echo -e "${RED}âŒ   âœ— /usr/share/applications/nautilus-vscode-widget.desktop${NC}"
        fi

        echo -e "${CYAN}â„¹ï¸  ğŸ” Verificando dependencias del sistema...${NC}"
        
        # Verificar dependencias principales
        if command -v python3 &> /dev/null; then
            PYTHON_VERSION=$(python3 --version 2>/dev/null | cut -d' ' -f2)
            echo -e "${GREEN}âœ…   âœ“ Python3: Python $PYTHON_VERSION${NC}"
        else
            echo -e "${RED}âŒ   âœ— Python3: No instalado${NC}"
        fi
        
        if python3 -c "import gi" &> /dev/null; then
            echo -e "${GREEN}âœ…   âœ“ PyGObject (GTK3)${NC}"
        else
            echo -e "${RED}âŒ   âœ— PyGObject (GTK3)${NC}"
        fi
        
        if python3 -c "import Xlib" &> /dev/null; then
            echo -e "${GREEN}âœ…   âœ“ python-xlib${NC}"
        else
            echo -e "${YELLOW}â„¹ï¸    â„¹ï¸  python-xlib no instalado (opcional)${NC}"
        fi

        echo -e "${GREEN}âœ… âœ¨ InstalaciÃ³n completada correctamente${NC}"

        echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${CYAN}  CÃ³mo usar el widget:${NC}"
        echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${YELLOW}1. Buscar 'Nautilus VSCode Widget' en el menÃº de aplicaciones${NC}"
        echo -e "${YELLOW}2. O ejecutar: nautilus-vscode-widget${NC}"
        echo -e "${YELLOW}3. Click derecho en el widget â†’ ConfiguraciÃ³n${NC}"
        echo -e "${YELLOW}4. Activar 'Inicio automÃ¡tico' si lo deseas${NC}"
        echo ""
        echo -e "${CYAN}ğŸ’¡ Mejora opcional:${NC}"
        echo -e "${CYAN}   Para mejor rendimiento en X11:${NC}"
        echo -e "${CYAN}   nautilus-vscode-widget-install-deps${NC}"
        echo ""

        # Configurar directorios de usuario
        echo -e "${CYAN}â„¹ï¸  ğŸ“ Configurando directorios de usuario...${NC}"
        mkdir -p "$HOME/.config/nautilus-vscode-widget" 2>/dev/null || true
        mkdir -p "$HOME/.local/share/nautilus-vscode-widget" 2>/dev/null || true
        echo -e "${GREEN}âœ…   Directorios de usuario creados${NC}"

        # Actualizar base de datos de aplicaciones
        echo -e "${CYAN}â„¹ï¸  ğŸ“ Actualizando base de datos de aplicaciones...${NC}"
        update-desktop-database /usr/share/applications 2>/dev/null || true
        echo -e "${GREEN}âœ…   Base de datos de aplicaciones actualizada${NC}"

        # Intentar iniciar automÃ¡ticamente
        echo -e "${CYAN}â„¹ï¸  ğŸš€ Iniciando Nautilus VSCode Widget automÃ¡ticamente...${NC}"
        if command -v python3 &> /dev/null && [ -f "/usr/share/nautilus-vscode-widget/nautilus-vscode-widget.py" ]; then
            timeout 10s python3 /usr/share/nautilus-vscode-widget/nautilus-vscode-widget.py &
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}âœ…   Widget iniciado automÃ¡ticamente${NC}"
            else
                echo -e "${YELLOW}âŒ   No se pudo iniciar el widget automÃ¡ticamente${NC}"
                echo -e "${CYAN}â„¹ï¸  Puedes iniciarlo manualmente con: nautilus-vscode-widget${NC}"
            fi
        else
            echo -e "${YELLOW}âŒ   No se pudo iniciar el widget automÃ¡ticamente${NC}"
            echo -e "${CYAN}â„¹ï¸  Puedes iniciarlo manualmente con: nautilus-vscode-widget${NC}"
        fi

        echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${GREEN}âœ… Â¡InstalaciÃ³n finalizada! El widget estÃ¡ listo para usar.${NC}"
        echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        ;;
esac

exit 0
