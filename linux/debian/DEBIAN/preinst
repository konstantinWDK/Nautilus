#!/bin/bash
# preinst script para nautilus-vscode-widget v3.3.6
# Instalador mejorado - versión estable

set -e

# Colores
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

case "$1" in
    install|upgrade)
        echo -e "${CYAN}🔄 Preparando instalación de Nautilus VSCode Widget v3.3.6...${NC}"

        # Solo detener si es una actualización (para evitar conflictos)
        if [ "$1" = "upgrade" ]; then
            echo -e "${YELLOW}⏹️  Deteniendo widget anterior para actualización...${NC}"
            # Usar timeout para evitar bloqueos
            timeout 5s pkill -f "nautilus-vscode-widget" 2>/dev/null || true
            timeout 5s pkill -f "nautilus-vscode-widget.py" 2>/dev/null || true
            sleep 0.5
        fi

        # Si es una actualización, limpiar archivos obsoletos
        if [ "$1" = "upgrade" ]; then
            echo -e "${CYAN}📦 Actualizando desde versión anterior...${NC}"

            # Limpiar posibles archivos residuales de versiones antiguas
            rm -f /usr/share/applications/nautilus-vscode-widget.desktop.old 2>/dev/null || true
            rm -f /usr/bin/nautilus-vscode-widget.old 2>/dev/null || true
            rm -f /usr/bin/nautilus-vscode-widget-install-deps.old 2>/dev/null || true
        fi

        # Verificar disponibilidad de herramientas opcionales
        MISSING_TOOLS=""
        if ! command -v xdotool &> /dev/null; then
            MISSING_TOOLS="$MISSING_TOOLS xdotool"
        fi
        if ! command -v wmctrl &> /dev/null; then
            MISSING_TOOLS="$MISSING_TOOLS wmctrl"
        fi

        if [ -n "$MISSING_TOOLS" ]; then
            echo -e "${YELLOW}ℹ️  Herramientas opcionales no instaladas:$MISSING_TOOLS${NC}"
            echo -e "${CYAN}   (No son necesarias, pero mejoran la compatibilidad)${NC}"
        fi

        echo -e "${GREEN}✅ Pre-instalación completada${NC}"
        ;;

    abort-upgrade)
        echo -e "${YELLOW}⚠️  Actualización abortada${NC}"
        ;;

    *)
        echo -e "${RED}Error: preinst llamado con argumento desconocido \`$1'${NC}" >&2
        exit 1
        ;;
esac

exit 0
